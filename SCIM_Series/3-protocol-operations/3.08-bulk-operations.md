# üèÜ Section 3.08 | Protocol Operations | ‚ÄúBulk Operations‚Äù

---

## üìå At a glance
Bulk operations in SCIM let you perform **multiple create, update, or delete actions in a single request**.  
This reduces network overhead and improves provisioning efficiency when dealing with large datasets.  

---

## üìñ What are Bulk Operations?
Bulk operations allow clients to send a **batch of SCIM requests** in one payload to the `/Bulk` endpoint.  
They‚Äôre especially useful for initial loads, mass updates, and license cleanups.

> **Notes**
- Defined in **RFC 7644, Section 3.7**.  
- Endpoint: `/Bulk`.  
- Each bulk request includes an array of operations with method, path, and data.  
- Support for Bulk is **optional** ‚Üí always check `/ServiceProviderConfig`.  

---

## ‚ùó Problem before SCIM Bulk
- Each provisioning action required a **separate HTTP call**.  
- High latency and API throttling made large syncs inefficient.  
- Example: Creating 10k users one by one could take hours.  
- Bulk introduced **batched, transactional-style provisioning**.  

---

## üîë Key characteristics
- **Single request** ‚Üí Many operations sent at once.  
- **Mixed verbs** ‚Üí POST, PATCH, PUT, DELETE can all appear in the same payload.  
- **Atomic vs non-atomic** ‚Üí Some servers support all-or-nothing commits, others partial.  
- **Response mapping** ‚Üí Each operation has a `bulkId` for correlation.  
- **Server-dependent** ‚Üí Bulk support varies widely by vendor.  
- **Error handling** ‚Üí Must check each operation‚Äôs response individually.  

---

## üåç Why it matters (and how it helps you later)
- Enables **faster onboarding** of large user populations.  
- Critical for **day-one migrations** and **license cleanups**.  
- Helps IAM engineers design scalable sync jobs.  
- Awareness of vendor limitations avoids failed rollouts.  

---

## üõ†Ô∏è Where it‚Äôs used (flows + impact)

### Example Flow
```
IdP ‚Üí POST /Bulk ‚Üí SaaS App
```

Payload might include:
- Create 50 new users  
- Update 10 departments  
- Disable 5 leavers  

Impact: Reduced latency and API rate-limit hits compared to 65 separate calls.  

---

## üîó How this links to other concepts
- [3.07 Attribute Selection](3.07-attribute-selection.md) ‚Üí Bulk payloads should minimize unnecessary fields.  
- [4.03 Common Failures](../4-security-error-handling/4.03-common-failures.md) ‚Üí Bulk has unique error-handling challenges.  
- [5.03 Troubleshooting](../5-real-world-implementation/5.03-troubleshooting.md) ‚Üí Bulk issues often surface during initial loads.  

---

## ‚öôÔ∏è Technical deep dive

### Example: Bulk create and update
```http
POST /Bulk
Content-Type: application/scim+json

{
  "schemas": ["urn:ietf:params:scim:api:messages:2.0:BulkRequest"],
  "Operations": [
    {
      "method": "POST",
      "path": "/Users",
      "bulkId": "q1",
      "data": {
        "userName": "jdoe",
        "name": { "givenName": "John", "familyName": "Doe" },
        "emails": [{ "value": "jdoe@example.com", "primary": true }]
      }
    },
    {
      "method": "PATCH",
      "path": "/Users/q1",
      "data": {
        "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
        "Operations": [{
          "op": "replace",
          "path": "department",
          "value": "Finance"
        }]
      }
    }
  ]
}
```

### Example response
```json
{
  "schemas": ["urn:ietf:params:scim:api:messages:2.0:BulkResponse"],
  "Operations": [
    { "bulkId": "q1", "status": "201", "location": "/Users/2819c223" },
    { "status": "200" }
  ]
}
```

**Key points**:  
- `bulkId` allows linking operations in a chain.  
- Responses are per operation, not just one global status.  
- Check vendor docs for atomicity guarantees.  

---

## üè¢ Real-world scenario
A university provisions 5,000 new students at semester start.  

- Bulk used for `POST /Users` with 5,000 entries.  
- Payload was split into 10 requests of 500 users each to avoid size limits.  
- Vendor only supported non-atomic mode, so partial failures were retried individually.  

**Impact:** Entire load completed in under an hour, instead of 12+ hours with single calls.  

---

## ‚ùå Common pitfalls
- Assuming all vendors support Bulk.  
- Not checking max payload size ‚Üí leads to request rejection.  
- Forgetting to use `bulkId` for linking dependent operations.  
- Expecting atomic commits where vendor only supports partial success.  
- Ignoring per-operation error responses.  

---

## ‚ö†Ô∏è Risks & issues

| Risk | Impact | Mitigation |
|------|--------|------------|
| Unsupported Bulk endpoint | Sync jobs fail | Check `/ServiceProviderConfig` before implementation |
| Payload too large | Request rejected | Split into smaller Bulk requests |
| Non-atomic behavior | Partial failures | Build retry logic for failed ops |
| No bulkId correlation | Orphan updates | Always use bulkId for references |

**Real-world:** A company attempted to bulk-provision 100k accounts in one request. Vendor capped payload size at 5k, causing silent truncation. Splitting into batches solved it.  

---

## üìù Mini quiz
1. What is the SCIM endpoint for Bulk operations?  
   a) `/Batch`  
   b) `/Bulk`  
   c) `/Operations`  
   d) `/Multi`  

2. Which SCIM field links dependent operations in a Bulk request?  
   a) `refId`  
   b) `bulkId`  
   c) `operationId`  
   d) `uuid`  

3. Scenario: You send a Bulk request with 10 operations, but 2 fail. What should you do?  
   a) Retry the whole request blindly  
   b) Inspect per-operation responses and retry failed ones  
   c) Assume atomic rollback occurred  
   d) Delete all and start over  

---

## üîó Navigation
üëâ Back: [3.07 Attribute Selection](3.07-attribute-selection.md)  
üëâ Next: [4.01 Authentication Options](../4-security-error-handling/4.01-authentication-options.md)  

‚û°Ô∏è Next, we‚Äôll explore **Authentication Options (4.01)** to see how SCIM endpoints are protected using OAuth2, MTLS, and API keys.
