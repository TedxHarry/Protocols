# 🏆 Section 4.02 | Security & Error Handling | “Error Codes”

---

## 📌 At a glance
Error codes in SCIM provide **standardized responses** when requests fail.  
They help clients understand the cause of failure and guide corrective action.  

---

## 📖 What are SCIM Error Codes?
SCIM builds on **HTTP status codes** and extends them with structured error responses.  
Errors include details in JSON to describe what went wrong and how to fix it.

> **Notes**
- Defined in **RFC 7644, Section 3.12**.  
- Uses standard HTTP codes (400, 401, 403, 404, 409, 500).  
- Adds `scimType` for **specific error categories** (e.g., `invalidValue`).  
- Response always includes `schemas`, `detail`, `status`.  

---

## 🔑 Key characteristics
- **HTTP + JSON body** → Clear machine- and human-readable info.  
- **Common codes**:  
  - 400 → Bad Request (invalid input).  
  - 401 → Unauthorized (auth failed).  
  - 403 → Forbidden (not allowed).  
  - 404 → Resource not found.  
  - 409 → Conflict (duplicate or violation).  
  - 500 → Server error.  
- **scimType examples**: `invalidSyntax`, `invalidFilter`, `uniqueness`, `mutability`.  
- **Consistency across vendors** → Easier troubleshooting across systems.  

---

## 🌍 Why it matters (and how it helps you later)
- Standard errors make integrations easier to debug.  
- As an IAM engineer, you’ll see SCIM errors often during **mapping, sync, and token expiration**.  
- Correct error handling is critical for **resilient sync jobs** and **audit evidence**.  

---

## 🛠️ Where it’s used (flows + impact)

### Example Flow
```
IdP → SCIM Server → Error Response → Logs / Retries
```
- Joiner → `POST /Users` rejected due to missing `userName`.  
- Mover → `PATCH /Users` rejected due to unsupported attribute.  
- Leaver → `PATCH /Users` failed with expired token.  

Impact: Errors direct you to fix mappings, retry with new tokens, or adjust attribute configs.  

---

## 🔗 How this links to other concepts
- [4.01 Authentication Options](4.01-authentication-options.md) → Errors 401/403 tie directly to failed authentication.  
- [4.03 Common Failures](4.03-common-failures.md) → Error codes reveal recurring failure patterns.  
- [5.03 Troubleshooting](../5-real-world-implementation/5.03-troubleshooting.md) → You’ll interpret errors during hands-on debugging.  

---

## ⚙️ Technical deep dive

### Example: Missing required attribute
```http
HTTP/1.1 400 Bad Request
Content-Type: application/scim+json

{
  "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
  "scimType": "invalidValue",
  "detail": "Missing required attribute userName",
  "status": "400"
}
```

### Example: Unsupported filter
```http
HTTP/1.1 400 Bad Request
Content-Type: application/scim+json

{
  "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
  "scimType": "invalidFilter",
  "detail": "Filter not supported",
  "status": "400"
}
```

### Example: Conflict error
```http
HTTP/1.1 409 Conflict
Content-Type: application/scim+json

{
  "schemas": ["urn:ietf:params:scim:api:messages:2.0:Error"],
  "scimType": "uniqueness",
  "detail": "Duplicate userName",
  "status": "409"
}
```

**Key fields**:  
- `schemas` → Always includes error schema URN.  
- `scimType` → Specific failure type.  
- `detail` → Human-readable message.  
- `status` → Mirrors HTTP status code.  

---

## 🏢 Real-world scenario
An integration between Azure AD and Slack failed mid-sync.  

- Azure sent `PATCH /Users` with unsupported attribute.  
- Slack returned 400 with `scimType: mutability`.  
- Engineers updated the mapping to exclude readOnly attributes.  

**Impact:** Errors guided the fix, preventing repeated failed runs.  

---

## ❌ Common pitfalls
- Ignoring error payloads, only checking HTTP code.  
- Not retrying transient errors (e.g., 500).  
- Assuming all vendors use the same `scimType` set.  
- Misinterpreting 409 conflicts → often due to duplicate externalId.  
- Not logging error details for audit evidence.  

---

## ⚠️ Risks & issues

| Risk | Impact | Mitigation |
|------|--------|------------|
| Ignored error payloads | Harder debugging | Parse full SCIM error JSON |
| Vendor variation | Misdiagnosis | Validate against `/ServiceProviderConfig` and docs |
| Duplicate resources | Sync breaks | Handle 409 with correlation rules |
| Token/permission failures | Jobs stop | Monitor 401/403 and refresh tokens |

**Real-world:** A provisioning team ignored 409 conflicts for weeks, leading to 200 duplicate accounts. Proper error handling would have prevented it.  

---

## 📝 Mini quiz
1. Which SCIM error `scimType` indicates a duplicate resource conflict?  
   a) `invalidFilter`  
   b) `uniqueness`  
   c) `mutability`  
   d) `invalidValue`  

2. What HTTP status code is returned when authentication fails?  
   a) 400  
   b) 401  
   c) 403  
   d) 409  

3. Scenario: You see 400 with `scimType: invalidFilter`. What does it mean?  
   a) Token expired  
   b) Filter not supported by server  
   c) Duplicate userName  
   d) Attribute is readOnly  

---

## 🔗 Navigation
👉 Back: [4.01 Authentication Options](4.01-authentication-options.md)  
👉 Next: [4.03 Common Failures](4.03-common-failures.md)  

➡️ Next, we’ll explore **Common Failures (4.03)** to see recurring provisioning errors and patterns across SCIM integrations.
