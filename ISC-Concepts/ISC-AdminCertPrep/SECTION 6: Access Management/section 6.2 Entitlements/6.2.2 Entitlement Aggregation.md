# 6.2.2 Entitlement Aggregation

**Learning Objective:** Understand how entitlements are discovered, aggregated, and maintained in SailPoint ISC.

---

## What is Entitlement Aggregation?

**Definition:** The process of discovering and importing entitlements from source systems into SailPoint ISC

**Simple Explanation:**
```
Entitlement Aggregation = ISC discovering what access exists in each source

Process:
  1. ISC connects to source (Active Directory)
  2. ISC reads groups, roles, permissions
  3. ISC catalogs them as entitlements
  4. ISC links entitlements to accounts
  5. ISC makes them visible/manageable
```

**Key Concept:**
```
Without aggregation:
  ISC doesn't know what entitlements exist
  Cannot provision entitlements
  Cannot show who has what access
  
After aggregation:
  ISC knows all available entitlements
  Can provision to accounts
  Can show access visibility
  Can manage entitlement lifecycle
```

**Exam Tip:** Entitlement aggregation happens during account aggregation. ISC reads account attributes to discover entitlements.

---

## How Entitlement Aggregation Works

### **Aggregation Process Flow**

**Step-by-Step Process:**
```
Step 1: ISC initiates aggregation
  Trigger: Scheduled (daily at 2 AM)
  Or: Manual (admin clicks "Aggregate Now")
  
Step 2: ISC connects to source
  Example: Connect to Active Directory
  Protocol: LDAP
  Authentication: Service account
  
Step 3: ISC queries accounts
  LDAP Query: (objectClass=user)
  Returns: All user accounts
  
Step 4: For each account, read attributes
  Account: john.smith
  Read attributes:
    - sAMAccountName: john.smith
    - givenName: John
    - sn: Smith
    - memberOf: [list of groups] ← Entitlements!
    
Step 5: Extract entitlements from attributes
  memberOf attribute contains:
    - CN=Domain Users,CN=Users,DC=company,DC=com
    - CN=VPN-Users,OU=Groups,DC=company,DC=com
    - CN=Sales-Team,OU=Groups,DC=company,DC=com
    
Step 6: Catalog entitlements
  ISC creates entitlement objects:
    Entitlement 1:
      Name: Domain Users
      Value: CN=Domain Users,CN=Users,DC=company,DC=com
      Type: group
      Source: Active Directory
      
    Entitlement 2:
      Name: VPN-Users
      Value: CN=VPN-Users,OU=Groups,DC=company,DC=com
      Type: group
      Source: Active Directory
      
    Entitlement 3:
      Name: Sales-Team
      Value: CN=Sales-Team,OU=Groups,DC=company,DC=com
      Type: group
      Source: Active Directory
      
Step 7: Link entitlements to account
  Account: john.smith
  Has entitlements:
    - Domain Users
    - VPN-Users
    - Sales-Team
    
Step 8: Update ISC database
  Store entitlement catalog
  Store account-to-entitlement mappings
  Update entitlement statistics
  
Step 9: Make visible in ISC
  Entitlements now visible in:
    - Entitlement catalog
    - Account details
    - Access request catalogs
    - Certification campaigns
```

---

### **Active Directory Example**

**First Aggregation (Discovery):**
```
Scenario: First-time AD aggregation

Before Aggregation:
  Entitlements in ISC: 0
  ISC knows: Nothing about AD groups
  
Aggregation Runs:
  Time: 2024-02-14 02:00:00
  Source: Active Directory
  Method: LDAP query via Virtual Appliance
  
Discovery Process:
  
  1. Connect to AD:
     Domain Controller: dc01.company.com
     Service Account: svc_sailpoint
     Protocol: LDAPS (636)
     
  2. Query all users:
     LDAP Filter: (objectClass=user)
     Results: 5,000 user accounts
     
  3. For each user, read memberOf:
     User 1 (john.smith):
       memberOf:
         - CN=Domain Users,CN=Users,DC=company,DC=com
         - CN=VPN-Users,OU=Groups,DC=company,DC=com
         - CN=Sales-Team,OU=Groups,DC=company,DC=com
         
     User 2 (jane.doe):
       memberOf:
         - CN=Domain Users,CN=Users,DC=company,DC=com
         - CN=HR-Team,OU=Groups,DC=company,DC=com
         - CN=Payroll-Access,OU=Groups,DC=company,DC=com
         
     ... (4,998 more users)
     
  4. Extract unique entitlements:
     Total unique groups discovered: 250
     
  5. Create entitlement catalog:
     Entitlement 1: Domain Users (5,000 members)
     Entitlement 2: VPN-Users (450 members)
     Entitlement 3: Sales-Team (250 members)
     Entitlement 4: HR-Team (75 members)
     Entitlement 5: Payroll-Access (12 members)
     ... (245 more entitlements)
     
After Aggregation:
  Entitlements in ISC: 250
  Total memberships: ~15,000 (avg 3 groups per user)
  
  ISC now knows:
    ✓ All AD groups that exist
    ✓ Who has each group
    ✓ How many members each group has
    ✓ Can provision these groups to users
    ✓ Can show access visibility
```

---

### **Salesforce Example**

**Salesforce Entitlement Aggregation:**
```
Source: Salesforce Production
Entitlement Types: Profiles, Permission Sets

Aggregation Process:

1. ISC connects to Salesforce:
   Method: Direct API (OAuth 2.0)
   API Version: v58.0
   
2. Query all users:
   API Call: GET /services/data/v58.0/query
   SOQL: SELECT Id, Username, ProfileId, PermissionSets FROM User
   Results: 500 users
   
3. For each user, read entitlements:
   User 1 (john.smith@company.com):
     ProfileId: 00exx000001abcd (Sales Cloud User)
     PermissionSets:
       - Marketing Cloud Access (04txx000000yzAB)
       - Advanced Reporting (04txx000000yzCD)
       
   User 2 (jane.doe@company.com):
     ProfileId: 00exx000001efgh (Standard User)
     PermissionSets:
       - (none)
       
4. Discover entitlements:
   Profiles discovered: 15
     - System Administrator (00exx000001aaaa)
     - Standard User (00exx000001bbbb)
     - Sales Cloud User (00exx000001abcd)
     - Marketing User (00exx000001efgh)
     ... (11 more)
     
   Permission Sets discovered: 25
     - Marketing Cloud Access (04txx000000yzAB)
     - Advanced Reporting (04txx000000yzCD)
     - API Access (04txx000000yzEF)
     ... (22 more)
     
5. Catalog in ISC:
   Total entitlements: 40 (15 profiles + 25 permission sets)
   
   Entitlement details example:
     Name: Sales Cloud User
     Value: 00exx000001abcd
     Type: profile
     Source: Salesforce Production
     Attribute: ProfileId
     Members: 150 users
     
After Aggregation:
  ✓ ISC knows all Salesforce profiles
  ✓ ISC knows all permission sets
  ✓ ISC knows who has which profile/permission sets
  ✓ Can provision profiles to new users
  ✓ Can grant permission sets via access requests
```

---

## Entitlement Attributes

### **Which Attributes Contain Entitlements**

**Active Directory:**
```
Primary Attribute: memberOf

Example:
  Account: john.smith
  
  memberOf attribute contains:
    [0] CN=Domain Users,CN=Users,DC=company,DC=com
    [1] CN=VPN-Users,OU=Groups,DC=company,DC=com
    [2] CN=Sales-Team,OU=Groups,DC=company,DC=com
    
  Each value = one entitlement
  Multi-valued attribute (can have many values)
```

**Salesforce:**
```
Primary Attributes: ProfileId, PermissionSets

Profile:
  Account: john.smith@company.com
  ProfileId: 00exx000001abcd
  
  Single-valued (one profile per user)
  
Permission Sets:
  Account: john.smith@company.com
  PermissionSets:
    [0] 04txx000000yzAB (Marketing Cloud)
    [1] 04txx000000yzCD (Advanced Reporting)
    
  Multi-valued (can have multiple permission sets)
```

**AWS:**
```
Primary Attributes: Groups, AttachedPolicies

IAM Groups:
  Account: john.smith
  Groups:
    [0] Developers
    [1] ReadOnly
    
IAM Policies:
  Account: john.smith
  AttachedPolicies:
    [0] arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
    [1] arn:aws:iam::123456789012:policy/CustomAppAccess
```

**Database (Oracle):**
```
Primary Attribute: Granted Roles

Account: JSMITH
Granted Roles:
  [0] CONNECT
  [1] RESOURCE
  [2] HR_READ
  [3] DBA (if admin)
  
Each role = one entitlement
```

---

## Entitlement Aggregation Modes

### **Full Aggregation**

**What is Full Aggregation:**
```
Complete discovery of all entitlements

Process:
  1. Read ALL accounts from source
  2. Extract ALL entitlements
  3. Rebuild complete entitlement catalog
  4. Update all account-to-entitlement mappings
  
When to use:
  ✓ First-time aggregation (initial discovery)
  ✓ After schema changes
  ✓ Periodic refresh (weekly/monthly)
  ✓ When data quality issues suspected
  ✓ After major source changes
```

**Full Aggregation Example:**
```
Schedule: Weekly (Sunday 2 AM)

Process:
  Start: 2024-02-14 02:00:00
  
  Step 1: Query all 5,000 accounts
  Step 2: Read memberOf for all 5,000
  Step 3: Extract all entitlements
  Step 4: Rebuild catalog (250 entitlements)
  Step 5: Update all 15,000 memberships
  
  End: 2024-02-14 02:45:00
  Duration: 45 minutes
  
Results:
  Accounts processed: 5,000
  Entitlements discovered: 250
  New entitlements: 2 (newly created groups)
  Removed entitlements: 1 (deleted group)
  Membership changes: 45 (users added/removed from groups)
```

---

### **Incremental/Delta Aggregation**

**What is Delta Aggregation:**
```
Only process changes since last aggregation

Process:
  1. Query ONLY changed accounts
  2. Extract entitlements from changed accounts
  3. Update only affected entitlements
  4. Faster than full aggregation
  
When to use:
  ✓ Daily aggregations
  ✓ Real-time/frequent updates
  ✓ Large environments (performance)
  ✓ Between full aggregations
```

**Delta Aggregation Example:**
```
Schedule: Daily (2 AM)

Process:
  Start: 2024-02-14 02:00:00
  
  Step 1: Query changed accounts (last 24 hours)
    Filter: whenChanged >= 2024-02-13 02:00:00
    Results: 50 accounts changed
    
  Step 2: Read entitlements for 50 changed accounts
  
  Step 3: Update affected entitlements:
    Account john.smith:
      Added to: Marketing-Team
      Removed from: (none)
      
    Account jane.doe:
      Added to: (none)
      Removed from: Temp-Project-Team
      
    ... (48 more changed accounts)
    
  Step 4: Update catalog
    Entitlement "Marketing-Team": +1 member
    Entitlement "Temp-Project-Team": -1 member
    
  End: 2024-02-14 02:05:00
  Duration: 5 minutes (much faster!)
  
Results:
  Accounts processed: 50 (only changed)
  Entitlements updated: 12 (only affected)
  Membership changes: 50
  
Performance:
  Full aggregation: 45 minutes (5,000 accounts)
  Delta aggregation: 5 minutes (50 accounts)
  90% faster ✓
```

---

### **Aggregation Strategy**

**Recommended Approach:**
```
Combine Full + Delta aggregations

Schedule:
  Daily: Delta aggregation (incremental changes)
    - Fast (5-10 minutes)
    - Captures daily changes
    - Keeps data current
    
  Weekly: Full aggregation (complete refresh)
    - Slower (30-60 minutes)
    - Catches missed changes
    - Validates data accuracy
    - Discovers new entitlements
    
Example Schedule:
  Monday-Saturday: Delta (2 AM)
  Sunday: Full (2 AM)
```

---

## Entitlement Discovery

### **How ISC Discovers New Entitlements**

**New Group Created in AD:**
```
Scenario: IT creates new group "Contractors"

Day 1 - Group created in AD:
  Time: 2024-02-14 10:00 AM
  Admin creates: CN=Contractors,OU=Groups,DC=company,DC=com
  Members: 0 (empty group initially)
  
  ISC status:
    ✗ ISC doesn't know group exists yet
    ✗ Not in entitlement catalog
    ✗ Cannot provision to users
    
Day 1 - User added to group:
  Time: 2024-02-14 10:15 AM
  Admin adds: bob.wilson to Contractors group
  
  AD:
    bob.wilson memberOf:
      - Domain Users
      - Contractors ← New!
      
  ISC status:
    ✗ Still doesn't know (no aggregation yet)
    
Day 2 - Delta aggregation runs:
  Time: 2024-02-15 02:00 AM
  
  Process:
    1. Query changed accounts
       bob.wilson changed (memberOf updated)
       
    2. Read bob.wilson memberOf:
       - Domain Users (existing)
       - Contractors (NEW!)
       
    3. ISC discovers new entitlement:
       Name: Contractors
       Value: CN=Contractors,OU=Groups,DC=company,DC=com
       Type: group
       Source: Active Directory
       Members: 1 (bob.wilson)
       
    4. Add to catalog
       Entitlement catalog: 250 → 251 entitlements
       
  ISC status:
    ✓ Contractors group now in catalog
    ✓ Shows bob.wilson has it
    ✓ Can provision to other users
    ✓ Appears in access catalogs
```

---

### **Empty Entitlements**

**Challenge: Groups with No Members:**
```
Problem:
  Group exists in AD: "Future-Project-Team"
  Members: 0 (nobody assigned yet)
  
  Delta aggregation:
    - No account has this group
    - No account changed to include it
    - ISC won't discover it!
    
Solution approaches:

1. Full Aggregation (discovers empty groups):
   Weekly full aggregation queries ALL groups
   Discovers groups even with 0 members
   
2. Direct Entitlement Aggregation:
   Some connectors support direct group queries
   Query: (objectClass=group)
   Discovers all groups regardless of membership
   
3. Manual entitlement import:
   Admin manually adds entitlement to catalog
   Before anyone needs it
```

**Direct Entitlement Query Example:**
```
Enhanced AD aggregation:

Step 1: Aggregate accounts (as usual)
  Discovers most groups via memberOf
  
Step 2: Additionally query all groups directly
  LDAP Query: (objectClass=group)
  Returns: ALL groups in AD (including empty)
  
  Results:
    - Domain Users (5,000 members)
    - VPN-Users (450 members)
    - Future-Project-Team (0 members) ← Discovered!
    - Decommissioned-App (0 members) ← Discovered!
    
Step 3: Catalog all groups
  Including empty groups
  Ready for provisioning when needed
  
Benefit:
  ✓ Complete entitlement catalog
  ✓ Can provision to empty groups
  ✓ No delay waiting for first member
```

---

## Entitlement Lifecycle Management

### **New Entitlements**

**When New Entitlements Appear:**
```
1. Discovered during aggregation
   - New group created in AD
   - New role created in database
   - New permission set in Salesforce
   
2. Automatically cataloged
   - Added to entitlement list
   - Available for provisioning
   - Visible in ISC
   
3. May need configuration
   - Add description (what is it for?)
   - Set risk level (low/medium/high?)
   - Assign owner (who manages it?)
   - Make requestable (can users request it?)
```

**New Entitlement Workflow:**
```
Day 1: Group created in AD
  Name: "DevOps-Team"
  Created by: IT admin
  
Day 2: Aggregation discovers it
  ISC finds new entitlement: DevOps-Team
  
Day 3: Admin configures in ISC
  Navigate: Admin → Entitlements
  Find: DevOps-Team
  
  Configure:
    Description: "DevOps team members - CI/CD access"
    Risk Level: Medium
    Owner: DevOps Manager
    Requestable: Yes
    Approver: DevOps Manager
    
Day 4: Available for use
  ✓ Users can request DevOps-Team access
  ✓ Can be included in roles
  ✓ Appears in certifications
  ✓ Fully integrated
```

---

### **Modified Entitlements**

**Entitlement Changes:**
```
Changes detected during aggregation:

Name Change:
  Before: "VPN-Users"
  After: "Remote-Access-Users"
  
  Aggregation detects:
    - Old entitlement no longer exists
    - New entitlement discovered
    
  ISC behavior:
    Option 1: Treated as delete + create (new entitlement)
    Option 2: Correlation detects rename (same DN/ID)
    
Membership Change:
  Before: 450 members
  After: 455 members (5 added)
  
  Aggregation updates:
    - Member count: 450 → 455
    - Account mappings updated
    - Changes logged
```

---

### **Deleted/Inactive Entitlements**

**When Entitlements Disappear:**
```
Scenario: Group deleted from AD

Before:
  Entitlement: "Temp-Project-Team"
  Members: 12 accounts
  Status: Active in ISC
  
Admin deletes group in AD:
  AD: Group removed
  Accounts: memberOf no longer includes this group
  
Next aggregation:
  ISC checks: Where is "Temp-Project-Team"?
  Not found in any account's memberOf
  No accounts have this entitlement
  
ISC behavior (configurable):
  
  Option 1: Mark as inactive
    Status: Active → Inactive
    Still in catalog (historical)
    Not requestable
    Shows on old accounts (historical view)
    
  Option 2: Delete from catalog
    Remove from entitlement list
    Historical data preserved
    No longer visible
    
  Recommended: Mark inactive (preserve history)
```

**Inactive Entitlement Example:**
```
Entitlement: "Legacy-App-Access"

Status: Inactive
Reason: Application decommissioned
Inactivated: 2024-01-15

Historical data preserved:
  - 45 accounts had this previously
  - Granted from: 2020-2023
  - Last member removed: 2024-01-10
  
Current state:
  ✗ Not requestable
  ✗ Not in access catalogs
  ✗ Not provisionable
  ✓ Still in reports (historical)
  ✓ Audit trail maintained
```

---

## Entitlement Correlation

### **Matching Entitlements Across Aggregations**

**Challenge:**
```
How does ISC know entitlement "VPN-Users" today
is the same as "VPN-Users" yesterday?

Need unique identifier to correlate
```

**Correlation Methods:**

**Method 1: By Value (DN, ID)**
```
Active Directory:
  Unique identifier: Distinguished Name (DN)
  
  Day 1: CN=VPN-Users,OU=Groups,DC=company,DC=com
  Day 2: CN=VPN-Users,OU=Groups,DC=company,DC=com
  
  Same DN = Same entitlement ✓
  
Salesforce:
  Unique identifier: Salesforce ID
  
  Day 1: 00exx000001abcd (Sales Cloud User profile)
  Day 2: 00exx000001abcd (same ID)
  
  Same ID = Same entitlement ✓
```

**Method 2: By Name + Source**
```
If no unique ID available:
  Correlation key: Name + Source
  
Example:
  Name: "VPN-Users"
  Source: "Active Directory"
  
  Same name + source = Same entitlement ✓
  
Risk:
  If group renamed, treated as new entitlement
```

---

## Entitlement Aggregation Configuration

### **Source-Specific Settings**

**Active Directory Configuration:**
```
Source: Active Directory
Aggregation Settings:

Entitlement Discovery:
  ☑ Discover groups from memberOf attribute
  ☑ Discover all groups (direct query)
  ☐ Discover nested groups (complex, performance impact)
  
Entitlement Attributes:
  Primary: memberOf
  Additional: (none)
  
Direct Group Query:
  Enabled: Yes
  Query: (objectClass=group)
  OU Filter: OU=Groups,DC=company,DC=com
    (Exclude: Built-in groups, system groups)
    
Aggregation Mode:
  Daily: Delta (incremental)
  Weekly: Full (complete)
```

**Salesforce Configuration:**
```
Source: Salesforce Production
Aggregation Settings:

Entitlement Types:
  ☑ Profiles (ProfileId)
  ☑ Permission Sets (PermissionSets)
  ☐ Public Groups (optional)
  
API Settings:
  Entitlement Query:
    Profiles: SELECT Id, Name FROM Profile
    Permission Sets: SELECT Id, Label FROM PermissionSet
    
Aggregation Mode:
  Daily: Full (Salesforce changes infrequent)
  Reason: Small entitlement count (~40 total)
```

---

## Monitoring Entitlement Aggregation

### **Aggregation Results**

**What to Monitor:**
```
After each aggregation:

Entitlement Statistics:
  Total entitlements: 250
  New entitlements: 2
  Updated entitlements: 5
  Removed entitlements: 1
  
Membership Changes:
  Members added: 45
  Members removed: 23
  Net change: +22 memberships
  
Performance:
  Duration: 5 minutes (delta) or 45 minutes (full)
  Accounts processed: 50 (delta) or 5,000 (full)
  Errors: 0
  
Alerts:
  ⚠ High-risk entitlement: New member in "Domain Admins"
  ⚠ Large membership change: VPN-Users +50 members
  ℹ New entitlement discovered: "Cloud-Team"
```

---

### **Entitlement Aggregation Logs**

**Log Example:**
```
2024-02-14 02:00:00 INFO [Aggregation] Starting AD aggregation (delta mode)
2024-02-14 02:00:05 INFO [Aggregation] Connected to dc01.company.com
2024-02-14 02:00:10 INFO [Aggregation] Querying changed accounts
2024-02-14 02:00:15 INFO [Aggregation] 50 accounts changed since last run
2024-02-14 02:00:20 DEBUG [Entitlement] Processing account: john.smith
2024-02-14 02:00:20 DEBUG [Entitlement] memberOf: Domain Users, VPN-Users, Marketing-Team
2024-02-14 02:00:20 DEBUG [Entitlement] New membership: Marketing-Team
2024-02-14 02:00:25 DEBUG [Entitlement] Processing account: jane.doe
2024-02-14 02:00:25 DEBUG [Entitlement] memberOf: Domain Users, HR-Team
2024-02-14 02:00:25 DEBUG [Entitlement] Removed membership: Temp-Project-Team
...
2024-02-14 02:04:50 INFO [Entitlement] Discovered 2 new entitlements
2024-02-14 02:04:50 INFO [Entitlement] Updated 12 existing entitlements
2024-02-14 02:04:55 INFO [Entitlement] Catalog updated: 252 total entitlements
2024-02-14 02:05:00 INFO [Aggregation] Aggregation complete
2024-02-14 02:05:00 INFO [Aggregation] Duration: 5 minutes
2024-02-14 02:05:00 INFO [Aggregation] Accounts: 50, Entitlements: 252, Changes: 50
```

---

## Practice Exercise

**Question:** Your company just connected Active Directory as a source in ISC. Describe what happens during the first entitlement aggregation and what you would expect to see.

<details>
<summary>Answer</summary>

**First-Time Active Directory Entitlement Aggregation:**

---

**Before Aggregation:**
```
ISC Status:
  Source: Active Directory (just configured)
  Connection: Tested successfully ✓
  Accounts in ISC: 0
  Entitlements in ISC: 0
  
  ISC knows:
    ✓ How to connect to AD
    ✓ Service account credentials
    ✓ Domain controllers to use
    ✗ What groups exist
    ✗ Who has what access
    ✗ Any entitlement information

Active Directory Reality:
  Domain: company.com
  User Accounts: 5,000
  Security Groups: 250
  Users with groups: All (everyone has at least Domain Users)
```

---

**Aggregation Process:**

**Step 1: Initiation**
```
Admin triggers aggregation:
  Admin → Connections → Sources → Active Directory
  Click: "Aggregate Now"
  
Or scheduled:
  Time: 2024-02-14 02:00:00 (configured schedule)
  
Log:
  2024-02-14 02:00:00 INFO [Aggregation] Starting AD aggregation
  2024-02-14 02:00:00 INFO [Aggregation] Mode: Full (first-time)
  2024-02-14 02:00:00 INFO [Aggregation] Source: Active Directory
```

**Step 2: Connection**
```
ISC connects to AD:
  Via: Virtual Appliance (VA-PROD-01)
  Protocol: LDAPS (port 636)
  Target: dc01.company.com
  Service Account: CN=svc_sailpoint,OU=Service,DC=company,DC=com
  
Log:
  2024-02-14 02:00:05 INFO [Aggregation] Connecting via VA-PROD-01
  2024-02-14 02:00:10 INFO [Aggregation] Connected to dc01.company.com:636
  2024-02-14 02:00:10 INFO [Aggregation] LDAP bind successful
  2024-02-14 02:00:10 INFO [Aggregation] Connection established
```

**Step 3: Account Discovery**
```
Query all user accounts:
  LDAP Query: (&(objectClass=user)(!(objectClass=computer)))
  Base DN: DC=company,DC=com
  Scope: Subtree (all OUs)
  
Log:
  2024-02-14 02:00:15 INFO [Aggregation] Querying user accounts
  2024-02-14 02:00:20 INFO [Aggregation] Found 5,000 user accounts
  2024-02-14 02:00:20 INFO [Aggregation] Beginning account processing
```

**Step 4: Entitlement Discovery**
```
For each account, read attributes:

Account 1: john.smith
  Attributes read:
    sAMAccountName: john.smith
    givenName: John
    sn: Smith
    mail: john.smith@company.com
    memberOf:
      - CN=Domain Users,CN=Users,DC=company,DC=com
      - CN=VPN-Users,OU=Groups,DC=company,DC=com
      - CN=Sales-Team,OU=Groups,DC=company,DC=com
      - CN=Marketing-Tools,OU=Groups,DC=company,DC=com
      
  Entitlements extracted:
    1. Domain Users
    2. VPN-Users
    3. Sales-Team
    4. Marketing-Tools

Account 2: jane.doe
  memberOf:
    - CN=Domain Users,CN=Users,DC=company,DC=com
    - CN=HR-Team,OU=Groups,DC=company,DC=com
    - CN=Payroll-Access,OU=Groups,DC=company,DC=com
    - CN=Benefits-Admin,OU=Groups,DC=company,DC=com
    
  Entitlements extracted:
    1. Domain Users (already discovered)
    2. HR-Team (new!)
    3. Payroll-Access (new!)
    4. Benefits-Admin (new!)

... (4,998 more accounts)

Log:
  2024-02-14 02:00:25 DEBUG [Entitlement] Processing john.smith
  2024-02-14 02:00:25 DEBUG [Entitlement] Found 4 groups
  2024-02-14 02:00:25 DEBUG [Entitlement] New entitlement: VPN-Users
  2024-02-14 02:00:25 DEBUG [Entitlement] New entitlement: Sales-Team
  2024-02-14 02:00:25 DEBUG [Entitlement] New entitlement: Marketing-Tools
  2024-02-14 02:00:30 DEBUG [Entitlement] Processing jane.doe
  2024-02-14 02:00:30 DEBUG [Entitlement] Found 4 groups
  2024-02-14 02:00:30 DEBUG [Entitlement] New entitlement: HR-Team
  2024-02-14 02:00:30 DEBUG [Entitlement] New entitlement: Payroll-Access
  2024-02-14 02:00:30 DEBUG [Entitlement] New entitlement: Benefits-Admin
  ...
```

**Step 5: Entitlement Catalog Creation**
```
Unique entitlements discovered: 250 groups

ISC creates entitlement catalog:

Entitlement 1:
  Name: Domain Users
  Display Name: Domain Users
  Value: CN=Domain Users,CN=Users,DC=company,DC=com
  Type: group
  Source: Active Directory
  Attribute: memberOf
  Members: 5,000 (all users)
  Risk Level: Low (default)
  Privileged: No
  Requestable: No (automatic)
  
Entitlement 2:
  Name: VPN-Users
  Display Name: VPN-Users
  Value: CN=VPN-Users,OU=Groups,DC=company,DC=com
  Type: group
  Source: Active Directory
  Attribute: memberOf
  Members: 450
  Risk Level: Low (default, needs review)
  Privileged: No
  Requestable: Yes (default)
  
Entitlement 3:
  Name: Sales-Team
  Display Name: Sales-Team
  Value: CN=Sales-Team,OU=Groups,DC=company,DC=com
  Type: group
  Source: Active Directory
  Attribute: memberOf
  Members: 250
  Risk Level: Low (default)
  Privileged: No
  Requestable: Yes
  
...

Entitlement 15:
  Name: Domain Admins
  Display Name: Domain Admins
  Value: CN=Domain Admins,CN=Users,DC=company,DC=com
  Type: group
  Source: Active Directory
  Attribute: memberOf
  Members: 3
  Risk Level: Low (default, NEEDS REVIEW!)
  Privileged: No (NEEDS REVIEW!)
  Requestable: Yes (NEEDS REVIEW!)
  
  ⚠ Admin should flag this for review!

... (235 more entitlements)

Log:
  2024-02-14 02:35:00 INFO [Entitlement] Catalog creation complete
  2024-02-14 02:35:00 INFO [Entitlement] Total entitlements: 250
  2024-02-14 02:35:00 INFO [Entitlement] Universal groups: 200
  2024-02-14 02:35:00 INFO [Entitlement] Global groups: 45
  2024-02-14 02:35:00 INFO [Entitlement] Domain Local groups: 5
```

**Step 6: Account-to-Entitlement Mapping**
```
Link accounts to entitlements:

Total mappings created: ~15,000
(5,000 accounts × ~3 groups average per account)

Examples:
  john.smith → Domain Users
  john.smith → VPN-Users
  john.smith → Sales-Team
  john.smith → Marketing-Tools
  
  jane.doe → Domain Users
  jane.doe → HR-Team
  jane.doe → Payroll-Access
  jane.doe → Benefits-Admin
  
  ... (14,992 more mappings)

Database updated:
  Accounts table: 5,000 rows
  Entitlements table: 250 rows
  Account_Entitlements table: 15,000 rows

Log:
  2024-02-14 02:40:00 INFO [Aggregation] Account-entitlement mapping complete
  2024-02-14 02:40:00 INFO [Aggregation] Total mappings: 15,000
```

**Step 7: Completion**
```
Aggregation summary:

Log:
  2024-02-14 02:45:00 INFO [Aggregation] Aggregation complete
  2024-02-14 02:45:00 INFO [Aggregation] === Summary ===
  2024-02-14 02:45:00 INFO [Aggregation] Duration: 45 minutes
  2024-02-14 02:45:00 INFO [Aggregation] Accounts processed: 5,000
  2024-02-14 02:45:00 INFO [Aggregation] Accounts created: 5,000
  2024-02-14 02:45:00 INFO [Aggregation] Entitlements discovered: 250
  2024-02-14 02:45:00 INFO [Aggregation] Entitlements created: 250
  2024-02-14 02:45:00 INFO [Aggregation] Memberships created: 15,000
  2024-02-14 02:45:00 INFO [Aggregation] Errors: 0
  2024-02-14 02:45:00 INFO [Aggregation] Status: Success
```

---

**After Aggregation:**

**ISC Status:**
```
Source: Active Directory
Last Aggregation: 2024-02-14 02:45:00
Status: Success
Accounts: 5,000
Entitlements: 250
```

**What Admin Can Now See:**

**1. Entitlement Catalog:**
```
Navigate: Admin → Entitlements

View:
  Total entitlements: 250
  Source: Active Directory (250)
  
List of entitlements:
  - Domain Users (5,000 members)
  - VPN-Users (450 members)
  - Sales-Team (250 members)
  - HR-Team (75 members)
  - IT-Admins (25 members)
  - Domain Admins (3 members) ⚠
  - Finance-Users (50 members)
  ... (243 more)

Can click on any entitlement to see:
  - Who has it
  - Description (empty, needs to be added)
  - Risk level (all default to Low, needs review)
  - Owner (none assigned, needs to be added)
```

**2. Account Details:**
```
Navigate: Admin → Identities → john.smith

View account: Active Directory (john.smith)

Entitlements:
  - Domain Users ✓
  - VPN-Users ✓
  - Sales-Team ✓
  - Marketing-Tools ✓

Can see what access john.smith has in AD
```

**3. Access Visibility:**
```
Navigate: Admin → Access

Can now see:
  - Who has what AD groups
  - Group membership counts
  - Access distribution
  - Orphaned accounts (if any)
```

---

**Next Steps (Admin Actions):**

**1. Review and Classify Entitlements:**
```
Immediate actions needed:

High-Risk Entitlements:
  Find privileged groups:
    - Domain Admins (3 members)
    - Enterprise Admins (2 members)
    - Schema Admins (1 member)
    - Account Operators (5 members)
    
  Configure:
    Risk Level: High
    Privileged: Yes
    Requestable: Yes (but highly restricted)
    Approval: Multi-level (Manager + IT Director + CISO)
    Certification: Monthly
    
Medium-Risk Entitlements:
  Groups like VPN-Users, remote access, etc.:
    Risk Level: Medium
    Requestable: Yes
    Approval: Manager
    Certification: Quarterly
    
Low-Risk Entitlements:
  Department groups, standard access:
    Risk Level: Low
    Requestable: Yes
    Approval: Manager (or auto-approve)
    Certification: Quarterly or annual
```

**2. Add Descriptions:**
```
For each entitlement, add business context:

VPN-Users:
  Description: "Remote access to corporate network via VPN"
  Business Purpose: "Work from home, remote work"
  Owner: IT Operations
  
Sales-Team:
  Description: "Sales department team members"
  Business Purpose: "Sales resource access, team collaboration"
  Owner: Sales Operations
  
Domain Admins:
  Description: "PRIVILEGED: Full Active Directory administrative access"
  Business Purpose: "AD administration, emergency access only"
  Owner: IT Director
  Compliance Notes: "SOX critical, monthly certification required"
```

**3. Configure Access Requests:**
```
Make appropriate entitlements requestable:

Requestable (most groups):
  ☑ VPN-Users
  ☑ Sales-Team
  ☑ Marketing-Team
  ☑ HR-Team (with restrictions)
  
Not Requestable (automatic or privileged):
  ☐ Domain Users (automatic)
  ☐ Domain Admins (special process)
  ☐ Authenticated Users (automatic)
```

**4. Plan Certifications:**
```
Setup certification campaigns:

Monthly: Privileged groups
  - Domain Admins
  - Enterprise Admins
  - Schema Admins
  
Quarterly: Standard groups
  - VPN-Users
  - Department groups
  - Application access groups
```

---

**What Users Can Now Do:**

**Access Requests:**
```
User can log into ISC:
  Request Access → Browse Catalog
  
  See AD entitlements:
    - VPN-Users (requestable) ✓
    - Sales-Team (requestable) ✓
    - Marketing-Team (requestable) ✓
    
  Cannot see:
    - Domain Users (not requestable, automatic)
    - Domain Admins (admin must configure first)
```

**Access Visibility:**
```
User views own access:
  My Profile → Accounts → Active Directory
  
  Can see own groups:
    - Domain Users
    - VPN-Users
    - Sales-Team
    
  Understand what access they have
```

---

**Ongoing Aggregation:**

**Daily Delta Aggregation:**
```
Schedule: Daily at 2 AM

Next day (2024-02-15 02:00):
  Mode: Delta (incremental)
  Process: Only changed accounts (much faster)
  Duration: 5-10 minutes (vs. 45 minutes full)
  
Discovers:
  - New group memberships
  - Removed group memberships
  - New groups (if anyone added to them)
  
Keeps ISC current with AD changes
```

**Weekly Full Aggregation:**
```
Schedule: Sunday 2 AM

Every Sunday:
  Mode: Full (complete refresh)
  Process: All 5,000 accounts
  Duration: 45 minutes
  
Benefits:
  - Catches any missed changes
  - Discovers empty groups (direct query)
  - Validates data accuracy
  - Comprehensive refresh
```

---

**Summary of First Aggregation:**
```
What Happened:
  ✓ 5,000 AD accounts discovered
  ✓ 250 AD groups (entitlements) cataloged
  ✓ 15,000 group memberships mapped
  ✓ Complete visibility into AD access
  ✓ Foundation for provisioning
  ✓ Foundation for access requests
  ✓ Foundation for certifications
  
Time: 45 minutes (first-time full aggregation)

What ISC Can Now Do:
  ✓ Show who has what AD access
  ✓ Provision AD groups to users
  ✓ Enable access requests for AD groups
  ✓ Run access certifications
  ✓ Generate AD access reports
  ✓ Manage AD entitlement lifecycle
  
What Admin Must Do:
  ⚠ Review and classify entitlements (risk levels)
  ⚠ Add descriptions and owners
  ⚠ Configure privileged group controls
  ⚠ Setup access request policies
  ⚠ Plan certification campaigns
```

**Exam Tip:** First aggregation discovers ALL entitlements and creates complete catalog. Delta aggregations keep it current. Always review and classify privileged entitlements after first aggregation.

</details>

---

## Section Summary

**Core Concepts for Certification:**

✅ **Entitlement Aggregation:**
- Process of discovering entitlements from sources
- Happens during account aggregation
- Reads account attributes (memberOf, ProfileId, etc.)
- Creates entitlement catalog in ISC

✅ **Aggregation Process:**
1. Connect to source
2. Query accounts
3. Read entitlement attributes
4. Extract unique entitlements
5. Create catalog entries
6. Link entitlements to accounts

✅ **Aggregation Modes:**
- **Full**: All accounts, complete refresh (weekly)
- **Delta**: Only changed accounts, incremental (daily)
- **Strategy**: Daily delta + weekly full

✅ **Discovery Methods:**
- **Account-based**: Read memberOf from accounts (discovers used entitlements)
- **Direct query**: Query all groups (discovers all entitlements including empty)
- **Best**: Combine both approaches

✅ **Entitlement Lifecycle:**
- **New**: Discovered during aggregation, needs configuration
- **Modified**: Membership/name changes detected
- **Deleted**: Marked inactive, preserved for history

✅ **Key Attributes:**
- **AD**: memberOf (multi-valued, contains group DNs)
- **Salesforce**: ProfileId (single), PermissionSets (multi-valued)
- **AWS**: Groups, AttachedPolicies
- **Database**: Granted Roles

✅ **After Aggregation:**
- Entitlements visible in catalog
- Can provision to accounts
- Available for access requests
- Ready for certifications
- Must configure: descriptions, risk levels, owners

**Exam Focus Areas:**
- Know aggregation discovers entitlements from accounts
- Understand full vs. delta aggregation
- Remember memberOf attribute for AD groups
- Know first aggregation creates complete catalog
- Understand delta only processes changes (faster)
- Remember to classify privileged entitlements after discovery
- Know entitlements linked to accounts (not identities directly)

---

**End of Section 6.2.2: Entitlement Aggregation**

**Next:** Section 6.2.3: Entitlement Descriptions and Metadata

---

**Study Tips:**
- **Aggregation**: Discovers entitlements from source
- **Full mode**: All accounts (weekly, 45 min)
- **Delta mode**: Changed accounts only (daily, 5 min)
- **AD**: memberOf attribute contains groups
- **First aggregation**: Creates complete catalog
- **After**: Configure risk levels, descriptions, owners
- **Ongoing**: Delta keeps current, full validates
